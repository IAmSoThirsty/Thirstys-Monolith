name: Thirty's Monolith

# --- 1. THE ALL-SEEING TRIGGERS ---
# Consolidates triggers from all your separate files into one.
on:
  push:
    branches: [ "main", "cerberus-integration" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *'      # Midnight patrol (Stale, Dependabot)
  issues:
    types: [opened]          # For AI Summary & Greetings
  pull_request_target:
    types: [opened, synchronize] # For Labeler & Greetings
  workflow_dispatch:         # Manual override
    inputs:
      manual_reason:
        description: 'Reason for manual run'
        required: false
        default: 'Maintenance'

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write
  statuses: write
  id-token: write # Required for Google Cloud auth

jobs:

  # =================================================================
  # JOB 1: CODEX DEUS MAXIMUS (AI Auto-Fixer)
  # =================================================================
  # This job uses your custom Python agent to fix the repo before testing.
  ai-codex-agent:
    name: ü§ñ Codex Deus Maximus
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Ensure we can import the agent
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src

      - name: Run Codex Auto-Fix
        # This one-liner imports your agent and runs the fix_repo method
        run: |
          python -c "
          import sys, os
          sys.path.append(os.getcwd())
          try:
              from src.app.agents.codex_deus_maximus import create_codex
              print('ü§ñ Codex Deus Maximus is awakening...')
              codex = create_codex()
              report = codex.fix_repo()
              print('‚úÖ Codex Report:', report)
          except ImportError:
              print('‚ö†Ô∏è Codex agent not found in expected path, skipping auto-fix.')
          except Exception as e:
              print(f'‚ùå Codex encountered an error: {e}')
              sys.exit(1)
          "
        continue-on-error: true

      - name: Commit Codex Fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Codex Deus Maximus: Auto-corrected repository"

  # =================================================================
  # JOB 2: SECURITY & LINTING (Cerberus & CodeQL)
  # =================================================================
  security-audit:
    name: üõ°Ô∏è Security & Lint
    needs: ai-codex-agent
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive # Pulls Cerberus if linked

      # 1. Super-Linter
      - name: Super-Linter
        uses: github/super-linter@v4
        env:
          VALIDATE_ALL_CODEBASE: false
          DEFAULT_BRANCH: "main"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. CodeQL Analysis
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript
      - name: Autobuild
        uses: github/codeql-action/autobuild@v2
      - name: Run CodeQL
        uses: github/codeql-action/analyze@v2

      # 3. Pip Audit (Python Security)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Audit Tools
        run: pip install pip-audit
      - name: Run pip-audit
        run: pip-audit --format json -o pip_audit_report.json || true

      # 4. NPM Audit (Node Security)
      - name: npm audit
        run: npm audit --audit-level=moderate || true

  # =================================================================
  # JOB 3: BUILD & TEST MATRIX (Polyglot CI)
  # =================================================================
  build-test:
    name: üèóÔ∏è Build & Test
    needs: ai-codex-agent
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [python, node, android]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- PYTHON PATH ---
      - name: Python CI
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Run Python Tests (Cerberus Integrated)
        if: matrix.language == 'python'
        run: |
          pip install -r requirements.txt || true
          pip install pytest pytest-cov ruff mypy
          # Run Standard Tests
          pytest --cov=src --cov-report=xml:reports/coverage.xml -q
          # Run Cerberus Tests if present
          if [ -d "external/Cerberus" ]; then
            echo "üê∫ Running Cerberus Integration Tests..."
            cd external/Cerberus && pytest -q
          fi

      # --- NODE JS PATH ---
      - name: Node CI
        if: matrix.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      - name: Run Node Build
        if: matrix.language == 'node'
        run: |
          npm install
          npx webpack --mode=production
          npm test || echo "No tests found"

      # --- ANDROID PATH ---
      - name: Android CI
        if: matrix.language == 'android'
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Build APK
        if: matrix.language == 'android'
        run: |
          chmod +x gradlew
          ./gradlew build

      # --- DOCKER BUILD ---
      - name: Docker Build & Smoke Test
        if: matrix.language == 'python' # Run docker build alongside python
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: project-ai:ci

  # =================================================================
  # JOB 4: TRIAGE AGENTS (AI Summary & Management)
  # =================================================================
  triage-agents:
    name: üß† Triage Agents
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'pull_request_target'
    steps:
      - uses: actions/checkout@v4

      # 1. AI Issue Summarizer
      - name: AI Summarize Issue
        if: github.event_name == 'issues'
        uses: actions/ai-inference@v1
        id: inference
        with:
          prompt: |
            Summarize this issue in one paragraph:
            Title: ${{ github.event.issue.title }}
            Body: ${{ github.event.issue.body }}
      - name: Post Summary
        if: github.event_name == 'issues'
        run: gh issue comment $ISSUE_NUMBER --body '${{ steps.inference.outputs.response }}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}

      # 2. Auto Labeler
      - name: Auto Labeler
        if: github.event_name == 'pull_request_target'
        uses: actions/labeler@v4
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"

      # 3. Greetings
      - name: First Interaction Greeter
        uses: actions/first-interaction@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          issue-message: "Welcome to Project-AI! ü§ñ Codex Deus Maximus is analyzing your request."
          pr-message: "Greetings! The Monolith is now reviewing your contribution."

  # =================================================================
  # JOB 5: DEPLOYMENT (Cloud Run)
  # =================================================================
  deploy:
    name: üöÄ Deploy
    needs: [build-test, security-audit] # Only deploy if everything passes
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      # Datadog Synthetic Check before deploy
      - name: Datadog Pre-Flight
        uses: DataDog/synthetics-ci-github-action@v1.4.0
        with:
          api_key: ${{secrets.DD_API_KEY}}
          app_key: ${{secrets.DD_APP_KEY}}
          test_search_query: 'tag:e2e-tests'

      # Google Cloud Run Deploy
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider' # UPDATE THIS

      - name: 'Deploy to Cloud Run'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: '${{ env.SERVICE }}'
          region: '${{ env.REGION }}'
          source: './'
    env:
      PROJECT_ID: 'my-project' # UPDATE THIS
      REGION: 'us-central1'
      SERVICE: 'project-ai-service'

  # =================================================================
  # JOB 6: MAINTENANCE (Scheduled)
  # =================================================================
  maintenance:
    name: üßπ Daily Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Stale Issue Closer
        uses: actions/stale@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: 'This issue is stale. Codex Deus Maximus will close it soon.'
          days-before-stale: 60
